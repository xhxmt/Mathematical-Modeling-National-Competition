# 详尽解题思路文档

## 问题 1：指标相关特性分析

试分析胎儿 Y 染色体浓度与孕妇的孕周数和 BMI 等指标的相关特性，给出相应的关系模型，并检验其显著性。

### 1.1 变量间相关性分析

首先，明确变量类型：

- 分类变量（Nominal/Categorical Variable）
- 有序变量（Ordinal Variable）
- 定距变量（Scale/Interval Variable）

然后，对单个字段进行分布检验

- 绘制频率分布直方图，通过核密度估计计算概率密度函数，根据经验函数计算累计概率密度函数；
- 使用夏皮罗-威尔克检验（Shapiro–Wilk test，S-W test）检验数据是否符合正态分布；
- 使用威尔科克森秩和检验（Wilcoxon rank-sum test）或者柯尔莫戈洛夫-斯米诺夫检验（Kolmogorov-Smirnov test，K-S test）检验数据是否符合常见的分布，例如指数分布、泊松分布，卡方分布等等

根据数据分布以及变量类型，选择合适的假设检验方法：

- 分类变量 -- 分类变量：与列联表相关的检验方法
  - 卡方检验
  - 费舍尔精确检验
- 分类变量 -- 定距变量：独立样本检验
  - 如果定距变量是正态分布，选择参数检验
  - 如果定距变量不是正态分布，选择非参数检验
- 定距变量 -- 定距变量：线性相关系数，相关样本检验
  - 如果定距变量是正态分布，选择参数检验
  - 如果定距变量不是正态分布，选择非参数检验
  - 三大线性相关系数中：只有皮尔逊相关系数要求数据符合正态分布

### 1.2 问题拆解与目标

- **目标**：量化并检验 Y 浓度（连续比例）与孕周（连续）、BMI（连续）及其他协变量（年龄、体重、IVF、GC、读段数、mapping 比例等）之间的关系，并给出显著性检验。
- **挑战**：同一孕妇存在重复测量（纵向数据），Y 浓度为比例且受测序技术噪声影响，并且孕周对浓度的影响可能是非线性的（例如早期增长后趋于平稳）。

### 1.3 线性混合效应模型（LMM / GLMM）

$$
\text{logit}(Y_{ij}) = \beta_0 + b_{0i} + (\beta_1 + b_{1i}) \cdot t_{ij} + \beta_2 \cdot BMI_i + \beta_3 \cdot Age_i + \beta_4 \cdot IVF_i + \beta_5 \cdot GC_{ij} + \beta_6 \cdot Map_{ij} + \epsilon_{ij}
$$

- 下标说明：i 表示孕妇（个体），j 表示同一孕妇的第 j 次测量；\(t_{ij}\) 为孕周（数值化）。
- \(b_{0i}, b_{1i}\) 为个体随机截距与斜率，假设服从多元正态分布。
- 若 Y 在 (0,1) 且存在 0/1，可考虑 Beta 分布或把 0/1 做微扰后用 Beta 回归的混合效应版本。

### 1.4 非线性建模

- 用 GAM(M) 建模：

$$
\text{logit}(Y_{ij}) = \beta_0 + b_{0i} + s_1(t_{ij}) + s_2(BMI_i) + s_3(t_{ij}, BMI_i) + \ldots
$$

其中 \(s\) 为样条函数，允许捕捉孕周与 BMI 的非线性和交互。



## 问题 2：BMI 合理分组以及最佳 NIPT 时点

临床证明，男胎孕妇的 BMI 是影响胎儿 Y 染色体浓度的最早达标时间（即浓度达到或超过 4%的最早时间）的主要因素。试对男胎孕妇的 BMI 进行合理分组，给出每组的 BMI 区间和最佳 NIPT 时点，使得孕妇可能的潜在风险最小，并分析检测误差对结果的影响。



题目分为两个部分：

- 对 BMI 进行分组，给出每组的 BMI 区间
- 给出每组最佳的 NIPT 时间点



首先对数据做基本计算，得到每位孕妇的最早达标时间（最早检测孕周）：

- 若孕妇的多次观测值中存在一个大于 0.04 的值，存在一个小于 0.04 的值，则通过插值的方式得到该孕妇的最早达标时间

- 若孕妇不存在大于 0.04 的值，则事件未发生，将该孕妇记为右删失（censored），其随访时间为最后一次测量时间



### 2.1 生存函数

在题目里，男胎孕妇的“最早达标时间”就是一个 **事件发生时间**：

- **事件**：胎儿 Y 浓度第一次 ≥ 4%
- **时间**：孕周（或天）
- **删失**：如果孕妇最后一次检测都没达到 4%，那她的“达标时间”是未知的，这就是典型的“右删失”数据。

这种数据结构非常适合用 **生存分析（survival analysis）**，它的核心是估计 **生存函数**：
$$
S(t) = P(T > t)
$$
即在时间 t 之后仍未达标的概率。

![查看源图像](/Users/halley/Desktop/R.6a407a0ce92e60e27c7d2e5abf51ae9d.png)

对每一组孕妇（按 BMI 分组），我们可以用 Kaplan–Meier 方法估计 S(t)，得到一条生存曲线：

- 曲线开始时（孕周小），大多数胎儿未达标 → S(t) 接近 1
- 随孕周增加，更多胎儿达标 → S(t) 逐渐下降
- 当几乎所有胎儿都达标时，曲线趋近于 0

对 BMI 分组的准则可以是：

- 各组之间的生存函数差异最大/有显著不同



### 2.2 判断多组生存曲线差异

log-rank 检验是最常用的 **比较两组或多组生存曲线是否显著不同**的方法。

直观理解：

- 在每一个孕周（或时间点）上，比较 **组 A 和组 B 的“实际达标人数”** vs **如果两组没有差异时的“期望达标人数”**。
- 把所有时间点的差异加总，得到一个统计量。

数学上，log-rank 检验统计量是：
$$
\chi^2 = \frac{ \left(\sum (O - E)\right)^2 }{\sum Var(O - E)}
$$

- O：观察到的某组的达标人数
- E：在“无差异”假设下期望的达标人数

这个统计量近似服从卡方分布，p 值就能告诉你两组生存曲线是否显著不同。

不同 BMI 组的曲线如果差别大，说明 **BMI 对达标时间的影响显著**。



### 2.3 在 BMI 分组中的应用

- **目标**：找到 BMI 的分界点，使得分组后的生存曲线差异最大（p 值最小）。
- 做法：
  1. 先把孕妇按 BMI 从小到大排序。
  2. 在每个可能的分割点（比如 25、28、30、32 …）把人群分为两组。
  3. 计算两组的生存曲线，并做 log-rank 检验。
  4. 找到能产生最大统计量（或最小 p 值）的分割点。

使用递归二分 (recursive partitioning)进行多个分组

1. 先把总体看成一个整体。
2. 在所有候选 cutpoint 中，找到能让 log-rank 统计量最大的切点 → 分成两组。
3. 对每一组再递归执行步骤 2，直到：
   - 组内样本数太少，或
   - log-rank 检验差异不显著，才停止。



### 2.4 给出每组最佳的 NIPT 时间点

在生存曲线上找每组后 5%（或10%） 的点即可



## 问题 3：综合多个因素的 BMI 给出分组



本问题比问题2更复杂：需同时考虑多变量协同影响（静态协变量如 BMI、年龄、体重、妊次，测序质量指标为时间点可能变化的变量），同时更严格地考虑测序误差与删失。最佳策略：**联合建模（Joint Model）或带时间的多变量生存模型 + 模拟验证**。



## 问题 4：女胎异常判定方法

### 4.1 问题拆解与关键点

- 女胎没有 Y 染色体，需用 13/18/21 的 Z 值（列 Q,R,S）及 X 染色体的 Z 值（列 T），再结合 GC、读段数、被过滤读数比例（AA）和 BMI 等共同判定胎儿是否异常（AB 列给出检测出的非整倍体但为空代表未检出）。
- 关键问题：如何在保持高灵敏度的同时控制假阳性（特异性），以及低胎儿片段比例（fetal fraction）对检测灵敏度的影响。



### 4.2 单变量判定规则（经典）

- 常用阈值：|Z| ≥ 3 作为染色体非整倍体的预警线（需要结合实验室校准），若 13/18/21 中任一染色体 Z ≥ 3 则提示该染色体三体风险增加。
- X 染色体异常判断需谨慎：女性胎儿 X 染色体计数变化的信号较弱，且母体 X 影响较大；若 X 的 Z 异常需结合 fetal fraction（若可得）或其它证据判断。



### 4.3 多变量与机器学习判定流程

**构建一个集成判定器，用于输出患病概率 p (trisomy 13/18/21)**：

**候选特征**：

- Z13, Z18, Z21, ZX（列 Q,R,S,T）
- GC（列 P）、读段数 L、映射率 M、唯一比对 O、被过滤比例 AA
- 胎儿性染色体非整倍体 AB（可做训练 label 的辅助）
- BMI、年龄、孕次（AC）等影像学临床变量

**模型选择**：Logistic 回归（带 L1/L2 正则化）或梯度提升树（XGBoost/LightGBM），并在模型中加入概率校准（Platt 或 isotonic）。

**训练/验证**：

- 用已知标签（AE）进行监督学习；若标签不完备，采用半监督或弱监督策略。
- 采用交叉验证（k-fold），保持病例/对照比例一致（分层 CV）。
- 输出：概率 p，选择阈值以优化指定的敏感度/特异性（例如在孕检里常优先保证高敏感度）。

**性能度量**：ROC-AUC、PR-AUC（在低患病率时更有意义）、灵敏度/特异性、PPV/NPV、决策曲线分析。



### 4.4 多重检验与临床确认流程

- 由于同时检测多条染色体，需对多重检测做控制（例如 FDR 校正）或在阈值选取上更保守。
- 对模型判定为高风险的样本，建议进行第二次复测或进行侵入性确诊（羊水穿刺、绒毛取样）。





